<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DarkSource · 开发日志目录</title>
  <link rel="stylesheet" href="../assets/styles.css" />
  <style>
    main {
      max-width: var(--max-width);
      width: 100%;
      margin: 1.5rem auto 2rem;
      padding: 0 1rem;
    }

    .devlog-header {
      margin-bottom: 1rem;
    }

    .devlog-notes {
      font-size: 0.8rem;
      color: var(--text-sub);
      margin-top: 0.4rem;
      line-height: 1.6;
    }

    .devlog-list {
      list-style: none;
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: var(--text-sub);
    }

    .devlog-scroll-container {
      margin-top: 0.6rem;
    }

    .devlog-date-group {
      margin-bottom: 0.9rem;
      padding: 0.5rem 0.4rem 0.6rem;
      border-left: 4px solid rgba(0, 0, 0, 0.9);
      background: rgba(0, 0, 0, 0.25);
    }

    .devlog-date-heading {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.1rem 0.6rem;
      margin-bottom: 0.35rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      background: linear-gradient(to right, rgba(255, 230, 109, 0.95), rgba(255, 178, 107, 0.95));
      color: #111827;
      border: 2px solid #000000;
      box-shadow:
        0 2px 0 #000000,
        0 4px 0 rgba(0, 0, 0, 0.8);
    }

    .devlog-date-heading span.devlog-date-text {
      font-weight: 700;
    }

    .devlog-items {
      list-style: none;
      margin-left: 0.25rem;
    }

    .devlog-item {
      padding: 0.4rem 0.2rem;
      border-bottom: 2px solid rgba(0, 0, 0, 0.4);
    }

    .devlog-item:last-child {
      border-bottom: none;
    }

    .devlog-item-title {
      font-size: 0.95rem;
      color: var(--text-main);
      margin-bottom: 0.2rem;
    }

    .devlog-summary {
      font-size: 0.85rem;
      color: var(--text-sub);
      margin-top: 0.05rem;
    }

    .devlog-summary-line {
      margin-bottom: 0.2rem;
    }

    .devlog-summary-line:last-child {
      margin-bottom: 0;
    }

    .devlog-images {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.35rem;
    }

    .devlog-images img {
      max-width: 220px;
      border: 3px solid #000000;
      box-shadow:
        0 3px 0 #000000,
        0 6px 0 rgba(0, 0, 0, 0.85);
      image-rendering: pixelated;
      background: #000000;
    }

    .pixel-button-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      margin-top: 0.9rem;
    }

    @media (max-width: 768px) {
      main {
        margin-top: 1rem;
      }

      .devlog-date-group {
        padding-left: 0.35rem;
        padding-right: 0.35rem;
      }
    }
  </style>
</head>
<body class="page-loading">
  <div class="page">
    <header class="nav-wrap">
      <div id="nav-placeholder"></div>
    </header>

    <main>
      <section class="pixel-card">
        <div class="devlog-header">
          <h1 class="section-title">开发日志目录 DEV LOG INDEX</h1>
        </div>

        <div class="devlog-scroll-container" id="devlogScroll">
          <ul id="devlogList" class="devlog-list"></ul>
        </div>
      </section>
    </main>

    <footer>
      <div id="footer-placeholder"></div>
    </footer>
  </div>

  <script src="../assets/config.js"></script>
  <script src="../assets/include.js"></script>
  <script>
    function parseDateValue(dateStr) {
      if (typeof dateStr !== "string" || !dateStr) return 0;
      const normalized = dateStr.replace(/-/g, "");
      const num = Number(normalized);
      return Number.isFinite(num) ? num : 0;
    }

    async function loadDevlog() {
      const listEl = document.getElementById("devlogList");
      try {
        const res = await fetch("./config.json", { cache: "no-store" });
        if (!res.ok) {
          listEl.innerHTML = "<li>无法加载配置文件 devlog/config.json。</li>";
          return;
        }
        const rawItems = await res.json();
        if (!Array.isArray(rawItems) || rawItems.length === 0) {
          listEl.innerHTML = "<li>当前还没有开发日志记录。</li>";
          return;
        }

        // 1. 排序：按日期从新到旧
        const items = [...rawItems].sort((a, b) => {
          const da = parseDateValue(a?.date);
          const db = parseDateValue(b?.date);
          return db - da;
        });

        // 2. 分组：按日期分组
        const groups = new Map();
        items.forEach((item) => {
          const date = item?.date ?? "未设定日期";
          if (!groups.has(date)) {
            groups.set(date, []);
          }
          groups.get(date).push(item);
        });

        // summary 支持字符串或字符串数组，数组时每项一行
        function escapeHtml(s) {
          const t = String(s);
          return t
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;");
        }
        function summaryToHtml(summary) {
          if (Array.isArray(summary)) {
            return summary
              .filter((line) => line != null && String(line).trim() !== "")
              .map((line) => '<div class="devlog-summary-line">' + escapeHtml(line) + "</div>")
              .join("");
          }
          return '<div class="devlog-summary-line">' + escapeHtml(summary ?? "") + "</div>";
        }

        // 3. 渲染：按日期分组，从新到旧
        const html = Array.from(groups.entries())
          .map(([date, groupItems]) => {
            const groupHtml = groupItems
              .map((item) => {
                const summaryHtml = summaryToHtml(item.summary);
                const images = Array.isArray(item.images) ? item.images : [];

                const imagesHtml = images
                  .map((img) => {
                    if (!img) return "";
                    if (typeof img === "string") {
                      return '<img src="' + escapeHtml(img) + '" alt="devlog image" />';
                    }
                    const src = img.src ?? "";
                    if (!src) return "";
                    const alt = img.alt ?? "devlog image";
                    return '<img src="' + escapeHtml(src) + '" alt="' + escapeHtml(alt) + '" />';
                  })
                  .join("");

                return `
                  <li class="devlog-item">
                    <div class="devlog-summary">${summaryHtml}</div>
                    ${imagesHtml ? '<div class="devlog-images">' + imagesHtml + "</div>" : ""}
                  </li>
                `;
              })
              .join("");

            return `
              <li class="devlog-date-group">
                <div class="devlog-date-heading">
                  <span class="devlog-date-text">${date}</span>
                  <span>DEV LOG</span>
                </div>
                <ul class="devlog-items">
                  ${groupHtml}
                </ul>
              </li>
            `;
          })
          .join("");

        listEl.innerHTML = html;
      } catch (err) {
        console.error("加载 devlog/config.json 失败：", err);
        if (window.location.protocol === "file:") {
          listEl.innerHTML =
            "<li>当前通过 file:// 本地直接打开页面，浏览器禁止读取本地 JSON 文件。请使用本地服务器或部署到 GitHub Pages 后再访问。</li>";
        } else {
          listEl.innerHTML = "<li>加载配置时发生错误，请检查 JSON 格式或网络访问是否正常。</li>";
        }
      }
    }

    loadDevlog();
  </script>
</body>
</html>

